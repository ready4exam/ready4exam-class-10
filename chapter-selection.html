<script type="module">
import curriculum from "./js/curriculum.js";
import { transliterate as tr } from "https://cdn.jsdelivr.net/npm/transliteration/+esm";

// ALIGNED: Import authentication tools from your js folder
import { signInWithGoogle, checkAccess } from "./js/auth-paywall.js";

const CLASS_ID = "10";
const subject  = new URLSearchParams(location.search).get("subject") || "";

const content      = document.getElementById("content-container");
const diffBox      = document.getElementById("difficulty-container");
const startBtn     = document.getElementById("start-quiz");
const errorMsg     = document.getElementById("error-msg");
const subjectDesc  = document.getElementById("subject-desc");

let selectedBook = null;
let selectedChapter = null;
let selectedDifficulty = null;

// Subject Metadata - UNCHANGED
const meta = {
  Physics: "Explore mechanics, waves & thermodynamics.",
  Chemistry: "Atoms, reactions, bonding & periodicity.",
  Biology: "Cells, plants, human body & ecosystems.",
  Mathematics: "Numbers, algebra, geometry & graphs.",
  Hindi: "हिंदी साहित्य और व्याकरण का अभ्यास करें।"
};
subjectDesc.textContent = meta[subject] || "";

/* --------------------------
   BOOK LISTING - UNCHANGED
--------------------------- */
function renderBooks(){
  const data = curriculum[subject];
  document.getElementById("page-title").textContent = `Select Book`;
  
  if (!data) {
    content.innerHTML = "<p class='text-center text-gray-500'>No data available for this subject.</p>";
    return;
  }

  const fragment = document.createDocumentFragment();
  Object.keys(data).forEach(book => {
    const btn = document.createElement("button");
    btn.className = "topic-btn font-semibold text-lg";
    btn.textContent = book;
    btn.onclick = () => renderChapters(book);
    fragment.appendChild(btn);
  });

  content.innerHTML = "";
  content.appendChild(fragment);
  diffBox.classList.add("hidden");
  startBtn.disabled = true;
}

/* --------------------------
   CHAPTER LISTING - UNCHANGED
--------------------------- */
function renderChapters(book){
  selectedBook = book;
  const chapters = curriculum[subject][book];
  document.getElementById("page-title").textContent = book;

  const fragment = document.createDocumentFragment();
  chapters.forEach(ch => {
    const title = ch.chapter_title || ch.title || ch;
    const btn = document.createElement("button");
    btn.className = "topic-btn";
    btn.textContent = title;
    btn.onclick = (e) => selectChapter(title, e.currentTarget);
    fragment.appendChild(btn);
  });

  const back = document.createElement("button");
  back.className = "w-full text-cbse-blue font-bold py-2 mt-2 hover:underline";
  back.textContent = "← Change Book";
  back.onclick = renderBooks;
  fragment.appendChild(back);

  content.innerHTML = "";
  content.appendChild(fragment);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* --------------------------
   CHAPTER SELECTION - UNCHANGED
--------------------------- */
function selectChapter(title, button){
  document.querySelectorAll(".topic-btn").forEach(b => b.classList.remove("selected"));
  button.classList.add("selected");

  selectedChapter = title;
  diffBox.classList.remove("hidden");
  
  setTimeout(() => {
    diffBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

/* --------------------------
   DIFFICULTY SELECTION - UNCHANGED
--------------------------- */
document.querySelectorAll(".difficulty-btn").forEach(btn => {
  btn.onclick = e => {
    document.querySelectorAll(".difficulty-btn").forEach(x => x.classList.remove("selected"));
    e.target.classList.add("selected");
    selectedDifficulty = e.target.dataset.diff;
    startBtn.disabled = false;
    errorMsg.classList.add("hidden");
  };
});

/* --------------------------
   TABLE NAME GENERATOR - UNCHANGED
--------------------------- */
function buildTableName(chapter){
  let chapterSlug = tr(chapter || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  const skip = ["as","of","the","a","an","in","on","for","to","ki","ke","ka"];
  const words = chapterSlug.split(" ").filter(w => !skip.includes(w));

  const first = words[0] || "ch";
  const last  = words[words.length - 1] || "x";

  let subjectSlug = tr(subject)
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")
    .split(" ")[0] || "sub";

  return `${subjectSlug}_${first}_${last}_${CLASS_ID}_quiz`;
}

/* --------------------------
   START QUIZ (WITH MANDATORY LOGIN)
   PROFESSIONAL FIX: Pauses for Google Auth before redirecting.
--------------------------- */
startBtn.onclick = async () => {
  if (!selectedChapter || !selectedDifficulty) {
    errorMsg.textContent = "Please select a chapter and difficulty.";
    errorMsg.classList.remove("hidden");
    return;
  }

  // 1. Check if user already has an active session
  let user = checkAccess(); 

  // 2. Trigger Google Sign-In if not logged in
  if (!user) {
    user = await signInWithGoogle();
  }

  // 3. Proceed to Quiz only after successful authentication
  if (user) {
    const table = buildTableName(selectedChapter);
    const params = new URLSearchParams({
      class: CLASS_ID,
      subject,
      book: selectedBook,
      chapter: selectedChapter,
      difficulty: selectedDifficulty,
      table
    });
    // Redirect to quiz engine with parameters
    location.href = `quiz-engine.html?${params.toString()}`;
  } else {
    // Show error if user closes the login popup
    errorMsg.textContent = "Login is required to attempt the worksheet.";
    errorMsg.classList.remove("hidden");
  }
};

renderBooks();
</script>
